---
title: "Untitled"
author: "Gesa Amelung"
date: "7 November 2017"
output:
  html_document: default
  pdf_document: default
---

## Setup

Load the following packages and load the data base access scipt:

```{r setup, echo=TRUE, message=FALSE}
## load packages
require(RPostgreSQL)
require(sf)
require(knitr)

## load access data
path = 'D:/Gesa/Dokumente/Ecotoxicology/RPC'
source(file.path(path, 'amelung_access.R'))

```

## Loading data

Query PostgresSQL data base: bfg_monitoring
Cannot load full psm_samples so far, maybe internet is too weak.. Set LIMIT 100

```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

psm_sites = dbGetQuery(con, "SELECT *
                             FROM views.psm_sites_2005
                       ")
psm_samples = dbGetQuery(con, "SELECT *
                               FROM views.psm_samples_2005 sam
                               JOIN phch.phch_variables var 
                              ON var.variable_id = sam.variable_id 
                         WHERE var.psm_type = 'herbicide'
                         LIMIT 1000")

dbDisconnect(con)
dbUnloadDriver(drv)
```

```{r load-diatom-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

require(RPostgreSQL)
require(sf)
require(mapview)

dia_sites = dbGetQuery(con, "SELECT * FROM dia.dia_sites")
dia_sites_geo = st_read_db(con, query = "SELECT * FROM dia.dia_sites LIMIT 10")
dia_sam = dbGetQuery(con, "SELECT *
                       FROM dia.dia_samples
                       WHERE date > '2004-12-31'
                       ")
mapview(dia_sites_geo)

dbDisconnect(con)
dbUnloadDriver(drv)
```

## Question: How to compare diatom and psm sampling sites?
Where were samples taken at the same location?

Which column should I use to compare both datasets?
Random check if site_id exists in dia_sam.
Result: site_id is not the same in psm_samples and dia_sam.
Maybe labelling system is still the same, samples were just not always taken at same location?
```{r echo=TRUE, message=FALSE}
# Random site_id taken from psm_samples
dia_sam[dia_sam$site_id=="BW_10001",] #no result
dia_sam[dia_sam$site_id=="RP_10002",] #no results
# Random site_id taken from dia_samples as a cross-check if code is correct.
dia_sam[dia_sam$site_id=="BW_AI025.00",] #185 results

```
Is site_name, site_id and site_nr the same in psm_sites dataset? 
Find out by counting distinct occurence of them.
Result: site_id and site_name does not mean the same.
Site_id and site_nr might be approximately the same.
``` {r echo=TRUE, message=FALSE}
# Complete data set has to be queried before!!
psm_siteid_list <- unique(psm_sites$site_id)
nrow(as.data.frame(psm_siteid_list)) # 3116 different entries for site_id in psm_sites

psm_sitename_list <- unique(psm_sites$site_name)
nrow(as.data.frame(psm_sitename_list)) # 2746 different entries for site_name in psm_sites

psm_sitenr_list <- unique(psm_sites$site_nr)
nrow(as.data.frame(psm_sitenr_list)) # 3114 different entries for site_nr in psm_sites

```

Random check if site_nr in dia_sites and psm_sites are the same.
Result: site_nr in psm_sites and dia_sites are not the same.
Maybe labelling system is still the same, samples were just not always taken at same location?
Check the other way around. Are site_nr of dia_sites found in psm_sites?
Result: Positive. Dia samples were probably not taken at all psm sampling locations.
```{r echo=TRUE, message=FALSE}
# Random site_nr taken from psm_sites
dia_sites[dia_sites$site_nr=="CAC029",] # no results
dia_sites[dia_sites$site_nr=="21094",] # no results
dia_sites[dia_sites$site_nr=="CEN901",] # no results
# Random site_nr taken from dia_sites as a cross-check to see if code is correct.
dia_sites[dia_sites$site_nr=="CEZ016",] # 1 result

# Check the other way around. Are site_nr of dia_sites found in psm_sites? YES.
psm_sites[psm_sites$site_nr=="CEZ016",] # 1 result
dia_sites[dia_sites$site_nr=="CEZ016",] # 1 result
psm_sites[psm_sites$site_nr=="CKO317",] # 1 result
dia_sites[dia_sites$site_nr=="CKO317",] # 1 result
psm_sites[psm_sites$site_nr=="21081",] # 1 result
dia_sites[dia_sites$site_nr=="21081",] # no results
psm_sites[psm_sites$site_nr=="105703",] # 1 result
dia_sites[dia_sites$site_nr=="105703",] # 1 result


```

Random check if site_id in dia_sites and psm_sites are the same.
Result: NO. Only sometimes it works.
``` {r echo=TRUE, message=FALSE}
psm_sites[psm_sites$site_id=="BW_CEZ016",] # 1 result
dia_sites[dia_sites$site_id=="BW_CEZ016",] # no result
psm_sites[psm_sites$site_id=="BW_CKO317",] # 1 result
dia_sites[dia_sites$site_id=="BW_CKO317",] # no result
psm_sites[psm_sites$site_id=="BY_3390",] # 1 result
dia_sites[dia_sites$site_id=="BY_3390",] # 1 result


```
# Result
site_id cannot be used to connect psm_sites and dia_sites. Instead site_nr must be used
since attribut is found in both tables.


## Compare both sample datasets
Filter sites where diatom and herbicide data was measured in the same year.
``` {r compare-sample-datasets, echo=TRUE, message=FALSE}
# Join both sample data frames. Add a column identifying which source each row comes from.
dia_sam$table <- "dia"
psm_samples$table <- "psm"
dia_sam_bind <- dia_sam[,c("date", "site_id", "table")]
psm_sam_bind <- psm_samples[,c("date", "site_id", "table")]
samples_bind <- rbind(dia_sam_bind,psm_sam_bind) # combine both sample tables

```

Create data frames with samples only from 2005.
``` {r create-year-column, echo=TRUE, message=FALSE}
# Create year column from date column
dia_sam$year <- as.numeric(format(dia_sam$date,'%Y'))
psm_samples$year <- as.numeric(format(psm_samples$date,'%Y'))

# Create data frames with samples only from 2005
dia_sam_05 <- dia_sam[dia_sam$year=="2005",]
psm_sam_05 <- psm_samples[psm_samples$year=="2005",]

# common <- intersect(dia_sam_05[,"site_id"], psm_sam_05[,"site_id"]) # results in empty data

```
# Want to compare tables on year and site_id:
Include only herbicide data.
```{r  join-on-siteid, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

# Extract year from date
#sam_tab = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date, 
#                    EXTRACT(YEAR FROM dsam.date) AS sam_year,
#                    EXTRACT(YEAR FROM psam.date) AS psm_year
#                     FROM dia.dia_samples AS dsam
#                     INNER JOIN views.psm_samples_2005 AS psam 
#                     ON dsam.site_id = psam.site_id
#                    LIMIT 100");

# Horrible style but at least it works...
dia_herb_year = dbGetQuery(con, " SELECT dsam.site_id, psam.site_id, dsam.date AS d_date, dsam.taxon,
                     psam.date AS p_date
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON dsam.site_id = psam.site_id
                     JOIN phch.phch_variables AS var 
                      ON var.variable_id = psam.variable_id
                    WHERE var.psm_type = 'herbicide'
                     AND   (((dsam.date BETWEEN '2005-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2005-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2006-01-01' AND '2006-12-31')
                           AND (psam.date BETWEEN '2006-01-01' AND '2006-12-31'))
                     OR ((dsam.date BETWEEN '2007-01-01' AND '2007-12-31')
                           AND (psam.date BETWEEN '2007-01-01' AND '2007-12-31'))
                     OR ((dsam.date BETWEEN '2008-01-01' AND '2008-12-31')
                           AND (psam.date BETWEEN '2008-01-01' AND '2008-12-31'))
                     OR ((dsam.date BETWEEN '2009-01-01' AND '2009-12-31')
                           AND (psam.date BETWEEN '2009-01-01' AND '2009-12-31'))
                     OR ((dsam.date BETWEEN '2010-01-01' AND '2010-12-31')
                           AND (psam.date BETWEEN '2010-01-01' AND '2019-12-31'))
                     OR ((dsam.date BETWEEN '2011-01-01' AND '2011-12-31')
                           AND (psam.date BETWEEN '2011-01-01' AND '2011-12-31'))
                     OR ((dsam.date BETWEEN '2012-01-01' AND '2012-12-31')
                           AND (psam.date BETWEEN '2012-01-01' AND '2012-12-31'))
                     OR ((dsam.date BETWEEN '2013-01-01' AND '2013-12-31')
                           AND (psam.date BETWEEN '2013-01-01' AND '2013-12-31'))
                     OR ((dsam.date BETWEEN '2014-01-01' AND '20014-12-31')
                           AND (psam.date BETWEEN '2014-01-01' AND '2014-12-31'))
                     OR ((dsam.date BETWEEN '2015-01-01' AND '2015-12-31')
                           AND (psam.date BETWEEN '2015-01-01' AND '2015-12-31')))
                    LIMIT 100000
                    ")
         
dbDisconnect(con)
dbUnloadDriver(drv)
```
Why does this result in a list with much more sampled species than there is in the whole data set for diatom samples? -->  Code lists every possible combination of sampling dates.
Also, should I shorten the species name to include only genus and species and no further description?

# Creating a data frame
```{r  create-data-frame, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)



dia_sam_year = dbGetQuery(con, " SELECT *, 
                    EXTRACT(YEAR FROM dsam.date) AS year
                     FROM dia.dia_samples AS dsam
                    WHERE date >= '2005-01-01'
                    ")
dia_sam_year = dbGetQuery(con, " SELECT dsam.id_rs, dsam.id_pn, dsam.date, dsam.dv, dsam.iz_n, dsam.iz_b, dsam.cover, dsam.site_id, dsite.site_nr, 
                    EXTRACT(YEAR FROM dsam.date) AS year
                     FROM dia.dia_samples AS dsam
                     JOIN dia.dia_sites AS dsite 
                     ON dsam.site_id = dsite.site_id                  
                    WHERE date >= '2005-01-01'
                    ")

psm_sam_year = dbGetQuery(con, " SELECT  psam.sample_id, psam.site_id,psam.date, psam.qualifier, psam.value, psam.unit, var.name, var.cas, var.pgroup, var.psm_type, var.pan_class, psite.site_nr,
                    EXTRACT(YEAR FROM psam.date) AS year
                     FROM views.psm_samples_2005 AS psam
                      JOIN phch.phch_variables var 
                      ON var.variable_id = psam.variable_id
                      JOIN views.psm_sites_2005 AS psite 
                      ON psam.site_id = psite.site_id                    
                      WHERE date >= '2005-01-01'
                     AND var.psm_type = 'herbicide'
                    LIMIT 1000")

# Create the data frame
samples <- merge(dia_sam_year, psm_sam_year, by = c("site_nr","year"))
samples <- merge(dia_sam_year, psm_sam_year, by = "year")
samples2 <- merge(dia_sam_year, psm_sam_year, by = "site_nr")
# Works for year but not for site_nr.
#Error: cannot allocate vector of size 4.4 Gb -> if 100000 objects in both dataframes
# merge by site_id results in emtpy data
# results in empty data

dbDisconnect(con)
dbUnloadDriver(drv)
```

## Shorten taxon name
```{r  shorten-taxon-name, echo=TRUE, message=FALSE}
taxa_list <-unique(dia_herb_year$taxon)
taxa_cha <- as.character(taxa_list)
species_list <- sort(taxa_cha) #list of all species
species_list
nrow(as.data.frame(species_list))

taxa_genus <- sapply(strsplit(taxa_cha, ' '), '[', 1) # keeps only genus name
taxa_species <- sapply(strsplit(taxa_cha, ' '), '[', 2) # keeps only species name
genus_list<- sort(unique(taxa_temp))    #list of all genera
genus_list
nrow(as.data.frame(genus_list))

# combine genus and species name
taxon <- paste

```
There are 484 different species in the data set if limit is set to 100,000.

## Taxon frequency
Are there any rare species? Marchant (2002) suggests to remove rare species and Cao et al.(2001) suggests this if samples were taken over a large spatial scale which holds true for the present data. So the question is what a suitable definition for rare species is. E.g. species that occur in only 1 sample.

```{r  taxon-frequency, echo=TRUE, message=FALSE}

# taxon_count <- table(dia_sam$dv)
taxon_count <- table(dia_herb_year$taxon)
# taxon_count <- table(dia_sam$taxon)
summary(taxon_count)
taxon_count <-as.data.frame(taxon_count)
taxon_count2 <- taxon_count[order(taxon_count$Freq),]
head(taxon_count)
nrow(taxon_count)
nrow(taxon_count[taxon_count$Freq<5,])
nrow(taxon_count[taxon_count$Freq<3,])
nrow(taxon_count[taxon_count$Freq<2,])
hist(taxon_count$Freq, breaks = 50)



# Sollte ich seltene Arten weglassen? Wenn ja, welche Arten stufe ich als selten ein?
```
The distribution of species frequency s very left-skewed. Most speces are present in less than ~300 samples. However, few are present in more than 1000 samples.

```{r  read-taxalisten-data, echo=TRUE, message=FALSE}
samples_taxon <- merge(dia_sam_year, diatom_dat, by.x="dv", by.y="DV")
diatom_dat1<- read.table("C_Proben_Taxalisten.txt",header=T,sep="\t",dec=".")

```

```{r  suggestions-andreas, echo=TRUE, message=FALSE}
require(data.table)    # good for subsampling --> datacamp course
iris_dt <- as.data.table(iris)
class(iris_dt)
head(iris_dt)
iris_dt[i = 1:100, j = mean(Sepal.Length), by = Species]
diatom_dat1 <- fread("C_Proben_Taxalisten.txt") # schnellere funktion als read.csv usq. auch: fwrite()


require(dplyr)     # good for subsampling

iris$Sepal.Length
# with base package:
aggregate(iris$Sepal.Length, by = list(iris$Species), mean)

```

Load physical-chemical data
```{r load-phch-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

# there are more sites than psm_sites (including only pesticides) though they aren't necessary for us.
phch_samples = dbGetQuery(con, "SELECT *
                                FROM phch.phch_samples sam
                                JOIN phch.phch_variables var ON var.variable_id = sam.variable_id
                                WHERE var.name IN ('Wassertemperatur', 'Sulfat');")

dbDisconnect(con)
dbUnloadDriver(drv)
```

```{r get-variables, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)


var_names = dbGetQuery(con, "SELECT DISTINCT var.name
                                FROM phch.phch_samples sam
                                JOIN phch.phch_variables var ON var.variable_id = sam.variable_id
                                ")
# Nitrit, Nitrat-Stickstoff, Kalium, Sichttiefe, Chlorid, Nitrat, Gesamt-Phosphor, SÃ¤urekapazitÃ¤t bis pH 8,2, Sauerstoffgehalt, Sauerstoffzehrung nach 5 (7) Tagen ohne Hemmer, Gesamt-Stickstoff, SÃ¤urekapazitÃ¤t bis pH 4,3, Stickstoff, Wasserstand (OFW), pH-Wert (Feld) Ammonium-Stickstoff,  

dbDisconnect(con)
dbUnloadDriver(drv)
```