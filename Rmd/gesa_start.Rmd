---
title: "Untitled"
author: "Gesa Amelung"
date: "7 November 2017"
output:
  html_document: default
  pdf_document: default
---

## Setup

Load the following packages and load the data base access scipt:

```{r setup, echo=TRUE, message=FALSE}
## load packages
require(RPostgreSQL)
require(sf)
require(knitr)

## load access data
path = 'D:/Gesa/Dokumente/Ecotoxicology/RPC'
source(file.path(path, 'amelung_access.R'))

```

## Loading data

Query PostgresSQL data base: bfg_monitoring
Cannot load full psm_samples so far, maybe internet is too weak.. Set LIMIT 100

```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

psm_sites = dbGetQuery(con, "SELECT *
                             FROM views.psm_sites_2005
                       ")
psm_samples2 = dbGetQuery(con, "SELECT *
                               FROM views.psm_samples_2005 sam
                               JOIN phch.phch_variables var 
                              ON var.variable_id = sam.variable_id
                         WHERE var.psm_type = 'herbicide'
                         ORDER BY sam.sample_id
                         LIMIT 1000")


psm = dbGetQuery(con, "SELECT *
                               FROM views.psm_samples_2005 sam
                               
                         ORDER BY sam.sample_id
                         LIMIT 1000")

dbDisconnect(con)
dbUnloadDriver(drv)
```

```{r load-diatom-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

require(RPostgreSQL)
require(sf)
require(mapview)

dia_sites = dbGetQuery(con, "SELECT * FROM dia.dia_sites")
dia_sites_geo = st_read_db(con, query = "SELECT * FROM dia.dia_sites LIMIT 10")
dia_sam = dbGetQuery(con, "SELECT *
                       FROM dia.dia_samples
                       WHERE date > '2004-12-31'
                       ")
mapview(dia_sites_geo)

dbDisconnect(con)
dbUnloadDriver(drv)
```

Load physical-chemical data
```{r load-phch-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

# there are more sites than psm_sites (including only pesticides) though they aren't necessary for us.
phch_samples = dbGetQuery(con, "SELECT *
                                FROM phch.phch_samples sam
                                JOIN phch.phch_variables var ON var.variable_id = sam.variable_id
                                WHERE var.name IN ('Wassertemperatur', 'Sulfat');")

# 596477 observations

dbDisconnect(con)
dbUnloadDriver(drv)
```


## Compare both sample datasets
# Want to compare tables on year and site_id:
Extract year from date.
```{r  extract-year-from-date echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

sam_tab = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date, 
                    EXTRACT(YEAR FROM dsam.date) AS sam_year,
                    EXTRACT(YEAR FROM psam.date) AS psm_year
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON dsam.site_id = psam.site_id
                    LIMIT 100");


dbDisconnect(con)
dbUnloadDriver(drv)
```

Select all diatom samples where environmental variable data was measured at the same site in the same year and where herbicides were detected.

```{r  join-relevant-variables, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

join = dbGetQuery(con, " SELECT DISTINCT ON (dsam.site_id, dsam.date, dsam.taxon) psam.sample_id, dsam.site_id, dsam.date, taxon, iz_n, cover, var.psm_type, var.name
                   FROM dia.dia_samples AS dsam
                   INNER JOIN views.psm_samples_2005 AS psam
                   ON dsam.site_id = psam.site_id
                   INNER JOIN phch.phch_variables var 
                   ON var.variable_id = psam.variable_id 
                     WHERE var.psm_type = 'herbicide'
                   AND ((dsam.date BETWEEN '2005-01-01' AND '2005-12-31'
                   AND psam.date BETWEEN '2005-01-01' AND '2005-12-31')
                OR (dsam.date BETWEEN '2006-01-01' AND '2006-12-31'
                   AND psam.date BETWEEN '2006-01-01' AND '2006-12-31')
                OR (dsam.date BETWEEN '2007-01-01' AND '2007-12-31'
                   AND psam.date BETWEEN '2007-01-01' AND '2007-12-31')
                OR (dsam.date BETWEEN '2008-01-01' AND '2008-12-31'
                   AND psam.date BETWEEN '2008-01-01' AND '2008-12-31')
               OR (dsam.date BETWEEN '2009-01-01' AND '2009-12-31'
                   AND psam.date BETWEEN '2009-01-01' AND '2009-12-31')
                OR (dsam.date BETWEEN '2010-01-01' AND '2010-12-31'
                   AND psam.date BETWEEN '2010-01-01' AND '2010-12-31')
                 OR (dsam.date BETWEEN '2011-01-01' AND '2011-12-31'
                   AND psam.date BETWEEN '2011-01-01' AND '2011-12-31')
                 OR (dsam.date BETWEEN '2012-01-01' AND '2012-12-31'
                   AND psam.date BETWEEN '2012-01-01' AND '2012-12-31')
                 OR (dsam.date BETWEEN '2013-01-01' AND '2013-12-31'
                   AND psam.date BETWEEN '2013-01-01' AND '2013-12-31')
                OR (dsam.date BETWEEN '2014-01-01' AND '2014-12-31'
                   AND psam.date BETWEEN '2014-01-01' AND '2014-12-31')
                OR (dsam.date BETWEEN '2015-01-01' AND '2015-12-31'
                   AND psam.date BETWEEN '2015-01-01' AND '2015-12-31'))
                   ORDER BY dsam.date, dsam.site_id, dsam.taxon
                   ")
# results in 45980 observations

# Add column with year
join$year <- as.numeric(format(join$date, '%Y'))

# Add column with month
join$month <- as.numeric(format(join$date, '%m'))

# Shorten taxon name
join$taxon <- sub("^(\\S*\\s+\\S+).*", "\\1", join$taxon)

join$cover <- round(join$cover, digits = 4)


dbDisconnect(con)
dbUnloadDriver(drv)
```

```{r  join-2005, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

# Since iz_n (species abundance) is often empty,  I instead choose cover for abundance data.

# join2005b = dbGetQuery(con, " SELECT DISTINCT ON (dsam.site_id, dsam.taxon, dsam.date) dsam.site_id, dsam.date, taxon, dsam.iz_n, cover, psam.date, var.psm_type, var.name
                   FROM dia.dia_samples AS dsam
                   INNER JOIN views.psm_samples_2005 AS psam
                   ON dsam.site_id = psam.site_id
                   INNER JOIN phch.phch_variables var 
                   ON var.variable_id = psam.variable_id 
                  WHERE var.psm_type = 'herbicide'
                   AND (dsam.date BETWEEN '2005-01-01' AND '2005-12-31'
                   AND psam.date BETWEEN '2005-01-01' AND '2005-12-31')
                  ORDER BY dsam.date, dsam.site_id, dsam.taxon
                   ")

dbDisconnect(con)
dbUnloadDriver(drv)
```
## Shorten taxon name
```{r  shorten-taxon-name, echo=TRUE, message=FALSE}
taxa_list <-unique(join$taxon)
taxa_cha <- as.character(taxa_list)
species_list <- sort(taxa_cha) #list of all species
species_list
nrow(as.data.frame(species_list)) # 931 different taxa in the dataset

taxa_genus <- sapply(strsplit(taxa_cha, ' '), '[', 1) # keeps only genus name
taxa_species <- sapply(strsplit(taxa_cha, ' '), '[', 2) # keeps only species name
genus_list<- sort(unique(taxa_temp))    #list of all genera
genus_list
nrow(as.data.frame(genus_list))

# Keep only Genus + species name.
# join$taxon <- sub("^(\\S*\\s+\\S+).*", "\\1", join$taxon)
# Only 800 differet species left after shortening of the name.
```

# Subset data for specific years
```{r  subset-data-years, echo=TRUE, message=FALSE}
# within R and not via SQL query
join2005 <- subset(join, date < as.Date("2006-01-01"))
join2006 <- subset(join, (date < as.Date("2007-01-01"))&(date > as.Date("2005-12-31")))
join2007 <- subset(join, (date < as.Date("2008-01-01"))&(date > as.Date("2006-12-31")))
join2008 <- subset(join, (date < as.Date("2009-01-01"))&(date > as.Date("2007-12-31")))
join2009 <- subset(join, (date < as.Date("2010-01-01"))&(date > as.Date("2008-12-31")))
join2010 <- subset(join, (date < as.Date("2011-01-01"))&(date > as.Date("2009-12-31")))
join2011 <- subset(join, (date < as.Date("2012-01-01"))&(date > as.Date("2010-12-31")))
join2012 <- subset(join, (date < as.Date("2013-01-01"))&(date > as.Date("2011-12-31")))
join2013 <- subset(join, (date < as.Date("2014-01-01"))&(date > as.Date("2012-12-31")))
join2014 <- subset(join, (date < as.Date("2015-01-01"))&(date > as.Date("2013-12-31")))
join2015 <- subset(join, date > as.Date("2014-12-31"))

```

# Transform data with reshape2 package to get from long to wide data for the site_id.
```{r  transform-data-to-wide, echo=TRUE, message=FALSE}

# Create proper data format
dia05 <- data.frame(join2005$taxon, join2005$site_id, join2005$date, join2005$year, join2005$month, as.numeric(join2005$cover))
dia06 <- data.frame(join2006$taxon, join2006$site_id, join2006$date, join2006$year, join2006$month, as.numeric(join2006$cover))
dia07 <- data.frame(join2007$taxon, join2007$site_id, join2007$date, join2007$year, join2007$month, as.numeric(join2007$cover))
dia08 <- data.frame(join2008$taxon, join2008$site_id, join2008$date, join2008$year, join2008$month, as.numeric(join2008$cover))
dia09 <- data.frame(join2009$taxon, join2009$site_id, join2009$date, join2009$year, join2009$month, as.numeric(join2009$cover))
dia10 <- data.frame(join2010$taxon, join2010$site_id, join2010$date, join2010$year, join2010$month, as.numeric(join2010$cover))
dia11 <- data.frame(join2011$taxon, join2011$site_id, join2011$date, join2011$year, join2011$month, as.numeric(join2011$cover))
dia12 <- data.frame(join2012$taxon, join2013$site_id, join2013$date, join2012$year, join2012$month, as.numeric(join2013$cover))
dia13 <- data.frame(join2013$taxon, join2013$site_id, join2013$date, join2013$year, join2013$month, as.numeric(join2013$cover))
dia14 <- data.frame(join2014$taxon, join2014$site_id, join2014$date, join2014$year, join2014$month, as.numeric(join2014$cover))
dia15 <- data.frame(join2015$taxon, join2015$site_id, join2015$date, join2015$year, join2015$month, as.numeric(join2015$cover))

# Delete rows with missing values
dia05 <- dia05[complete.cases(dia05), ]
dia08 <- dia08[complete.cases(dia08), ]
dia09 <- dia09[complete.cases(dia09), ]
dia12 <- dia12[complete.cases(dia12), ]
# if conducted for 2012, no samples are left.


# Rename the columns
names(dia05) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia06) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia07) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia08) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia09) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia10) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia11) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia12) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia13) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia14) <- c("taxon", "site_id", "date", "year", "month", "cover" )
names(dia15) <- c("taxon", "site_id", "date", "year", "month", "cover" )

# Aggregate with reshape2
# require(reshape2)
# cast05a <- dcast(dia05, taxon + date ~ site_id, fill = 0)

# Like this, same species appear several times if it was sampled on different sites on
# several dates in the year.


# cast05 <- dcast(dia05, site_id ~ taxon, fill = 0) # length/amount of presence
# cast05 <- dcast(dia05, site_id ~ taxon, fill = 0, fun.aggregate = mean) # mean of cover
# cast05 <- dcast(dia05, site_id ~ taxon, fill = 0, min) # min of cover

#  In 2013 there is only one diatomeen sample and none in the years 2014 and 2015.
# (That meet the criteria that herbicides were sampled in the same year at the same site.)

# Aggregate with data.table
require(data.table)
#cast05<- data.table::dcast(dia05, site_id ~ taxon, fill=0, fun=mean)
#cast06<- data.table::dcast(dia06, site_id ~ taxon, fill=0, fun=mean)
#cast07<- data.table::dcast(dia07, site_id ~ taxon, fill=0, fun=mean)
#cast08<- data.table::dcast(dia08, site_id ~ taxon, fill=0, fun=mean)
#cast09<- data.table::dcast(dia09, site_id ~ taxon, fill=0, fun=mean)
#cast10<- data.table::dcast(dia10, site_id ~ taxon, fill=0, fun=mean)
#cast11<- data.table::dcast(dia11, site_id ~ taxon, fill=0, fun=mean)

# cast12<- data.table::dcast(dia12, site_id ~ taxon, fill=0, fun=mean)
# cast13<- data.table::dcast(dia13, site_id ~ taxon, fill=0, fun=mean)
# cast14<- data.table::dcast(dia14, site_id ~ taxon, fill=0, fun=mean)
# cast15<- data.table::dcast(dia15, site_id ~ taxon, fill=0, fun=mean)

cast05<- data.table::dcast(dia05, site_id ~ taxon, fill=0, fun=min)
cast06<- data.table::dcast(dia06, site_id ~ taxon, fill=0, fun=min)
cast07<- data.table::dcast(dia07, site_id ~ taxon, fill=0, fun=min)
cast08<- data.table::dcast(dia08, site_id ~ taxon, fill=0, fun=min)
cast09<- data.table::dcast(dia09, site_id ~ taxon, fill=0, fun=min)
cast10<- data.table::dcast(dia10, site_id ~ taxon, fill=0, fun=min)
cast11<- data.table::dcast(dia11, site_id ~ taxon, fill=0, fun=min)

# Calculating the 5th percentile of each cover entry

cov5th_05 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2005) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()

cov5th_06 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2006) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()

cov5th_07 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2007) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()

cov5th_08 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2008) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()

cov5th_09 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2009) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()

cov5th_10 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2010) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()

cov5th_11 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2011) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()

cov5th_12 <- select(join_cov, year, taxon,site_id, cover) %>%
  filter(year==2012) %>%
  group_by(site_id, taxon) %>%
  summarise('5 %' = quantile(cover, probs=0.05))  %>%
  as.data.frame()
# wieso sind auf einmal so viele Werte für 2015 da? Eigentlich sollten die cover = na werte rausgelöscht sein.

cast05 <-data.table::dcast(cov5th_05, site_id ~ taxon, fill =0)
cast06 <-data.table::dcast(cov5th_06, site_id ~ taxon, fill =0)
cast07 <-data.table::dcast(cov5th_07, site_id ~ taxon, fill =0)
cast08 <-data.table::dcast(cov5th_08, site_id ~ taxon, fill =0)
cast09 <-data.table::dcast(cov5th_09, site_id ~ taxon, fill =0)
cast10 <-data.table::dcast(cov5th_10, site_id ~ taxon, fill =0)
cast11 <-data.table::dcast(cov5th_11, site_id ~ taxon, fill =0)
cast12 <-data.table::dcast(cov5th_12, site_id ~ taxon, fill =0)


# removal of site information
cast05 <-cast05[, -1] 
cast06 <-cast06[, -1]
cast07 <-cast07[, -1] 
cast08 <-cast08[, -1]
cast09 <-cast09[, -1] 
cast10 <-cast10[, -1]
cast11 <-cast11[, -1] 
cast12 <-cast12[, -1]
# cast13 <-cast13[, -1] 
# cast14 <-cast14[, -1]
# cast15 <-cast15[, -1] 

```


```{r  remove-rare-species, echo=TRUE, message=FALSE}
# presence-absence transformation to calculate species number per site
require(vegan)
cast05_pa <-decostand(cast05, "pa") 
cast06_pa <-decostand(cast06, "pa") #works
cast07_pa <-decostand(cast07, "pa") #works
cast08_pa <-decostand(cast08, "pa")
cast09_pa <-decostand(cast09, "pa")
cast10_pa <-decostand(cast10, "pa") #works
cast11_pa <-decostand(cast11, "pa") #works
cast12_pa <-decostand(cast12, "pa")
# NAs in some cells. There, probably, not cover was measured but abundance/iz_n

# How many times does this happen?
sum(is.na(dia05$cover)) #1   # from 1704
sum(is.na(dia06$cover)) #0   
sum(is.na(dia07$cover)) #0
sum(is.na(dia08$cover)) #246 # from 4949
sum(is.na(dia09$cover)) #981 # from 10581
sum(is.na(dia10$cover)) #0   
sum(is.na(dia11$cover)) #0
sum(is.na(dia12$cover)) #8055 # from 8055
# try with again with removing all rows that have NAs. (done above)

# calculate sum per species
spec_sum05 <- apply(cast05_pa,2,sum)
# sort(spec_sum05)
spec_sum06 <- apply(cast06_pa,2,sum)
# sort(spec_sum06)
spec_sum07 <- apply(cast07_pa,2,sum)
# sort(spec_sum07)
spec_sum08 <- apply(cast08_pa,2,sum)
spec_sum09 <- apply(cast09_pa,2,sum)
spec_sum10 <- apply(cast10_pa,2,sum)
# sort(spec_sum10)
spec_sum11 <- apply(cast11_pa,2,sum)
# sort(spec_sum11)


# remove species that occur at less than 2 sites
# spec_sum needs to be calculated with number of presence data and here continued with cover data
spec_fin05 <- cast05[, ! spec_sum05 <2]
#sort(apply(spec_fin05, 2, max))   #check if it worked
spec_fin06 <- cast06[, ! spec_sum06 <2]
# sort(apply(spec_fin06, 2, max))
spec_fin07 <- cast07[, ! spec_sum07 <2]
# sort(apply(spec_fin07, 2, max))
spec_fin08 <- cast08[, ! spec_sum08 <2]
spec_fin09 <- cast09[, ! spec_sum09 <2]
spec_fin10 <- cast10[, ! spec_sum10 <2]
# sort(apply(spec_fin10, 2, max))
spec_fin11 <- cast11[, ! spec_sum11 <2]
# sort(apply(spec_fin11, 2, max))
# spec_fin12 <- cast12[, ! spec_sum12 <2]

```

Conduct DCA to see if axis length indicates unimodal gradient.
```{r  dca, echo=TRUE, message=FALSE}
require(vegan)
# axis lenght = SD. For axis length < 3, linear analysis should be used, for axis length >3, unimodal analysis should be performed.
# If presence-absence data is used: DCA1 length = 2.5
# If cover data (mean) is used: DCA1 length = 3.6 --> unimodal approach would be fine.

# Don't use decorana-values.
spec_dca05<- decorana(spec_fin05)
spec_dca05 #DCA1 length = 3.66 (mean);  = 3.63 (min); = 3.2 (5%)
# summary(spec_dca05, digits=3, origin=TRUE, display="both")

plot(spec_dca05, display="both") 
# crosses=species, points=sites
# shnam <- make.cepnames(names(spec_fin)) #abbreaviation of Latin names

spec_dca06<- decorana(spec_fin06)
spec_dca06 #DCA1 length = 7.48 (mean); = 7.56 (min); = 7.57 (5%)
plot(spec_dca06, display="both")

spec_dca07<- decorana(spec_fin07)
spec_dca07 #DCA1 length = 4.83 (mean); =4.69 (min); = 4.72
plot(spec_dca07, display="both")

spec_dca08<- decorana(spec_fin08)   # many samples deleted before
spec_dca08 #DCA1 length = 4.84 (mean); = 4.84 (min); = 4.85 (5%)
plot(spec_dca08, display="both")

spec_dca09<- decorana(spec_fin09)   # many samples deleted before
spec_dca09 #DCA1 length = 2.39 (mean); = 2.4; = 2.4 (5 %)
plot(spec_dca09, display="both")

spec_dca10<- decorana(spec_fin10)
spec_dca10 #DCA1 length = 4.31 (mean); 4.29 (min); = 4.34 (5%)
plot(spec_dca10, display="both")

spec_dca11<- decorana(spec_fin11)
spec_dca11 #DCA1 length = 6.13 (mean); = 6.07 (min); = 6.09 (5%)
plot(spec_dca11, display="both")

# Conducting unimodal analysis would be okay for all years except for 2009.
# No big difference between taken the mean or the minimum of the cover values.
```

## Visualize the sampling frequency
Sampling day per year
```{r sampling-days-per-year, echo=TRUE, message=FALSE}
# sample_id
# count number of sampling_id per year
require(dplyr)

event_counts <- join %>%
  group_by(year) %>%
  summarise(sampling_events_count = n_distinct(sample_id))  %>%
   as.data.frame()

for(i in 1:2) #should produce two figures next to each other
barplot(event_counts[ ,2], names.arg = event_counts[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per year")

# Delete rows where cover was not measured but instead abundance
join_cov <- select(join, taxon, sample_id, site_id, year, month, cover)
join_cov <- join_cov[complete.cases(join_cov), ]
# 39583 of 45980 entries remain
join_cov <- join_cov[!join_cov$cover=="0", ]
# 39270 entries remain

event_counts_cov <- join_cov %>%
  group_by(year) %>%
  summarise(sampling_events_count = n_distinct(sample_id))  %>%
   as.data.frame()

barplot(event_counts_cov[ ,2], names.arg = event_counts_cov[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per year - Cover")

```

Samples per year
```{r  sampling-frequency, echo=TRUE, message=FALSE}
# count number of samples per year
# The species of each site are counted seperately
require(dplyr)

sample_counts <- join %>%
  group_by(year) %>%
  summarise(sample_count = n()) %>%
  as.data.frame()

barplot(sample_counts[ ,2], names.arg = sample_counts[ ,1], xlab="Year", ylab="Number of samples", main=" Sample counts per year")

## Without rows where abundance was measured instead of cover

sample_counts_cov <- join_cov %>%
  group_by(year) %>%
  summarise(sampling_events_count = n())  %>%
   as.data.frame()

barplot(sample_counts_cov[ ,2], names.arg = sample_counts_cov[ ,1], xlab="Year", ylab="Number of samples", main="Samples per year - Cover")

```

```{r  sampling-frequency-2005, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2005 ##
# Event counts
event_counts_2005 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2005) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2005[ ,2], names.arg = event_counts_2005[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2005")

# Sample counts
# The species of each site are counted seperately
sample_counts_2005 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2005) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2005[ ,2], names.arg = sample_counts_2005[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2005")
```

```{r  sampling-frequency-2006, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2006 ##
# Event counts
event_counts_2006 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2006) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2006[ ,2], names.arg = event_counts_2006[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2006")

# Sample counts
# The species of each site are counted seperately
sample_counts_2006 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2006) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2006[ ,2], names.arg = sample_counts_2006[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2006")
```

```{r  sampling-frequency-2007, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2007 ##
# Event counts
event_counts_2007 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2007) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2007[ ,2], names.arg = event_counts_2007[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2007")

# Sample counts
# The species of each site are counted seperately
sample_counts_2007 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2007) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2007[ ,2], names.arg = sample_counts_2007[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2007")
```

```{r  sampling-frequency-2008, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2008 ##
# Event counts
event_counts_2008 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2008) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2008[ ,2], names.arg = event_counts_2008[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2008")

# Sample counts
# The species of each site are counted seperately
sample_counts_2008 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2008) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2008[ ,2], names.arg = sample_counts_2008[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2008")
```

```{r  sampling-frequency-2009, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2009 ##
# Event counts
event_counts_2009 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2009) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2009[ ,2], names.arg = event_counts_2009[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2009")

# Sample counts
# The species of each site are counted seperately
sample_counts_2009 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2009) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2009[ ,2], names.arg = sample_counts_2009[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2009")
```

```{r  sampling-frequency-2010, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2010 ##
# Event counts
event_counts_2010 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2010) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2010[ ,2], names.arg = event_counts_2010[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2010")

# Sample counts
# The species of each site are counted seperately
sample_counts_2010 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2010) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2010[ ,2], names.arg = sample_counts_2010[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2010")
```

```{r  sampling-frequency-2011, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2011 ##
# Event counts
event_counts_2011 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2011) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2011[ ,2], names.arg = event_counts_2011[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2011")

# Sample counts
# The species of each site are counted seperately
sample_counts_2011 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2011) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2011[ ,2], names.arg = sample_counts_2011[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2011")
```

```{r  sampling-frequency-2012, echo=TRUE, message=FALSE}
require(dplyr)
# Only rows considered with cover column filled out

## 2012 ##
# Event counts
event_counts_2012 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2012) %>%
  group_by(month) %>%
  summarise(sampling_count = n_distinct(sample_id))  %>%
   as.data.frame()
  
# for(i in 1:2) #should produce two figures next to each other
barplot(event_counts_2012[ ,2], names.arg = event_counts_2012[ ,1], xlab="Year", ylab="Number of sampling events", main="Event counts per month of 2012")

# Sample counts
# The species of each site are counted seperately
sample_counts_2012 <- select(join_cov, sample_id, year, month) %>%
  filter(year==2012) %>%
  group_by(month) %>%
  summarise(sampling_count = n())  %>%
   as.data.frame()
  
barplot(sample_counts_2012[ ,2], names.arg = sample_counts_2012[ ,1], xlab="Year", ylab="Number of samples", main="Samples per month of 2012")
```

```{r  blank, echo=TRUE, message=FALSE}
# calculate minimale Deckung pro Monat und site (und Taxon) berechnen over all years together.
cast05<- data.table::dcast(dia05, site_id ~ taxon, fill=0, fun=min)


dia <- select(join, taxon, site_id, date, month, cover)
dia$cover <- as.numeric(dia$cover)
dia <- dia[complete.cases(dia), ]

require(data.table)
cast <- data.table::dcast(join, site_id ~ taxon, fill = 0, fun.aggregate=min, value.var = "cover")
# species that occur at less than 2 sites not removed.

dia <- select(join_cov, taxon, site_id, month, cover) %>%
  group_by(month, site_id, taxon) %>%
  summarise_each(funs(min_cover = min(cover), mean_cover = mean(cover), quantile(cover, 0.05), count = n())) %>%
  as.data.frame()
# dia has 34162 entries



```

              
```

Conduct CA
```{r  ca, echo=TRUE, message=FALSE}
require(vegan)
# conduct CA
spec_ca <- cca(spec_fin)
spec_ca
plot(spec_ca) # species scores as weighted averages of site scores.
chisq.test(spec_fin/sum(spec_sum))
# x-squared = inertia from aboce, p-values not important
plot(spec_ca, scaling =1) #site scores as weighted averages of species scores

# CA for all years seperately
spec_ca06 <- cca(spec_fin05)
plot(spec_ca05)
spec_ca06 <- cca(spec_fin06)
plot(spec_ca06)
spec_ca07 <- cca(spec_fin07)
plot(spec_ca07)
spec_ca08 <- cca(spec_fin08)
plot(spec_ca08)
spec_ca09 <- cca(spec_fin09)
plot(spec_ca09)
spec_ca10 <- cca(spec_fin10)
plot(spec_ca10)
spec_ca11 <- cca(spec_fin11)
plot(spec_ca11)
# Arch effect not so visible, mostl< only on one side. Outliers make interpretation hard.

```

# Creating a data frame
```{r  create-data-frame, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

# Functions not needed at the moment but keep them anyways, just in case.

dia_sam_year = dbGetQuery(con, " SELECT *, 
                    EXTRACT(YEAR FROM dsam.date) AS year
                     FROM dia.dia_samples AS dsam
                    WHERE date >= '2005-01-01'
                    ")
dia_sam_year = dbGetQuery(con, " SELECT dsam.id_rs, dsam.id_pn, dsam.date, dsam.dv, dsam.iz_n, dsam.iz_b, dsam.cover, dsam.site_id, dsite.site_nr, 
                    EXTRACT(YEAR FROM dsam.date) AS year
                     FROM dia.dia_samples AS dsam
                     JOIN dia.dia_sites AS dsite 
                     ON dsam.site_id = dsite.site_id                  
                    WHERE date >= '2005-01-01'
                    ")

psm_sam_year = dbGetQuery(con, " SELECT  psam.sample_id, psam.site_id,psam.date, psam.qualifier, psam.value, psam.unit, var.name, var.cas, var.pgroup, var.psm_type, var.pan_class, psite.site_nr,
                    EXTRACT(YEAR FROM psam.date) AS year
                     FROM views.psm_samples_2005 AS psam
                      JOIN phch.phch_variables var 
                      ON var.variable_id = psam.variable_id
                      JOIN views.psm_sites_2005 AS psite 
                      ON psam.site_id = psite.site_id                    
                      WHERE date >= '2005-01-01'
                     AND var.psm_type = 'herbicide'
                    LIMIT 1000")

# Create the data frame
samples <- merge(dia_sam_year, psm_sam_year, by = c("site_nr","year"))
samples <- merge(dia_sam_year, psm_sam_year, by = "year")
samples2 <- merge(dia_sam_year, psm_sam_year, by = "site_nr")
# Works for year but not for site_nr.
#Error: cannot allocate vector of size 4.4 Gb -> if 100000 objects in both dataframes
# merge by site_id results in emtpy data
# results in empty data

dbDisconnect(con)
dbUnloadDriver(drv)
```



## Taxon frequency
Are there any rare species? Marchant (2002) suggests to remove rare species and Cao et al.(2001) suggests this if samples were taken over a large spatial scale which holds true for the present data. So the question is what a suitable definition for rare species is. E.g. species that occur in only 1 sample.

```{r  taxon-frequency, echo=TRUE, message=FALSE}

# taxon_count <- table(dia_sam$dv)
taxon_count <- table(join$taxon)
# taxon_count <- table(dia_sam$taxon)
summary(taxon_count)
taxon_count <-as.data.frame(taxon_count)
taxon_count <- taxon_count[order(taxon_count$Freq),]
head(taxon_count)
freqn <- nrow(taxon_count) # 931   #800 after name shortening
freq3 <- nrow(taxon_count[taxon_count$Freq<5,]) # 383   # 327 after name shortening
freq2 <- nrow(taxon_count[taxon_count$Freq<3,]) # 274   # 229 after name shortening
freq1 <- nrow(taxon_count[taxon_count$Freq<2,]) # 172   # 141 after name shortening
hist(taxon_count$Freq, breaks = 50)   

# relative frequency of species that are only present at 1 site
freq1/freqn*100       # 17.6 % of all species are only present at 1 site
freq1/nrow(join)*100 # 0.3 % of all Samples-site combinations represent a species that was sampled only once.


# Sollte ich seltene Arten weglassen? Wenn ja, welche Arten stufe ich als selten ein?
```
The distribution of species frequency is very left-skewed. Most speces are present in less than ~200 samples and few are present in more than 200 samples.

```{r  read-taxalisten-data, echo=TRUE, message=FALSE}
samples_taxon <- merge(dia_sam_year, diatom_dat, by.x="dv", by.y="DV")
diatom_dat1<- read.table("C_Proben_Taxalisten.txt",header=T,sep="\t",dec=".")

```

```{r  suggestions-andreas, echo=TRUE, message=FALSE}
require(data.table)    # good for subsampling --> datacamp course
iris_dt <- as.data.table(iris)
class(iris_dt)
head(iris_dt)
iris_dt[i = 1:100, j = mean(Sepal.Length), by = Species]
diatom_dat1 <- fread("C_Proben_Taxalisten.txt") # schnellere funktion als read.csv usq. auch: fwrite()


require(dplyr)     # good for subsampling

iris$Sepal.Length
# with base package:
aggregate(iris$Sepal.Length, by = list(iris$Species), mean)

```


```{r get-variables, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)


var_names = dbGetQuery(con, "SELECT DISTINCT var.name
                                FROM phch.phch_samples sam
                                JOIN phch.phch_variables var ON var.variable_id = sam.variable_id
                                ")
# Nitrit, Nitrat-Stickstoff, Kalium, Sichttiefe, Chlorid, Nitrat, Gesamt-Phosphor, Sauerstoffgehalt, Sauerstoffzehrung nach 5 (7) Tagen ohne Hemmer, Gesamt-Stickstoff, Stickstoff, Wasserstand (OFW), pH-Wert (Feld) Ammonium-Stickstoff, Sauerstoffzehrung nach 7 Tagen mit Hemmer, BSB5, sedimentiert, Sauerstoffzehrung nach 21 Tagen mit Hemmer, TrÃ¼bung (physiko-chem. Messung), Elektrische LeitfÃ¤higkeit (20Â°C), Nitrit-Stickstoff, Natrium, Sulfat, Ammonium, Abfluss, spektraler Absorptionskoeffizient 436nm, freie KohlensÃ¤ure, SauerstoffsÃ¤ttigung, Stickstoff, Hydrogenkarbonat, Eisen, Wassertemperatur, Magnesium, Gesamtphosphor als PO4, Phosphor, Chemischer Sauerstoffbedarf

dbDisconnect(con)
dbUnloadDriver(drv)
```

```{r load-ec50-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

ec50 = dbGetQuery(con, "SELECT variable_id, name, n_al, ec50_al_fr_min, ec50_al_fr_min_taxa, ec50_al_fr_perc20, ec50_al_fr_mean
                                FROM phch.phch_ec50
                                LIMIT 100
                                ")


dbDisconnect(con)
dbUnloadDriver(drv)
```