---
title: "Untitled"
author: "Gesa Amelung"
date: "7 November 2017"
output:
  html_document: default
  pdf_document: default
---

## Setup

Load the following packages and load the data base access scipt:

```{r setup, echo=TRUE, message=FALSE}
## load packages
require(RPostgreSQL)
require(sf)
require(knitr)

## load access data
path = 'D:/Gesa/Dokumente/Ecotoxicology/RPC'
source(file.path(path, 'amelung_access.R'))

```

## Loading data

Query PostgresSQL data base: bfg_monitoring
Cannot load full psm_samples so far, maybe internet is too weak.. Set LIMIT 100

```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

psm_sites = dbGetQuery(con, "SELECT *
                             FROM views.psm_sites_2005
                       ")
psm_samples = dbGetQuery(con, "SELECT *
                               FROM views.psm_samples_2005 sam
                               JOIN phch.phch_variables var 
                              ON var.variable_id = sam.variable_id 
                               LIMIT 1000")

dbDisconnect(con)
dbUnloadDriver(drv)
```

```{r load-diatom-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

require(RPostgreSQL)
require(sf)
require(mapview)

dia_sites = dbGetQuery(con, "SELECT * FROM dia.dia_sites")
dia_sites_geo = st_read_db(con, query = "SELECT * FROM dia.dia_sites LIMIT 10")
# dia_sam = dbGetQuery(con, "SELECT * FROM dia.dia_samples LIMIT 100")
mapview(dia_sites_geo)

dbDisconnect(con)
dbUnloadDriver(drv)
```

## Get  diatom samples sampled after 2004

There are diatom samples from 2004 in the database. For the PSM data, no samples of 2004 are in the database. Therefore, data doesn't need to be queried specifically.

```{r load-diatom-2005-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

dia_sam = dbGetQuery(con, "SELECT *
                       FROM dia.dia_samples
                       WHERE date > '2004-12-31'
                       ")

dbDisconnect(con)
dbUnloadDriver(drv)
```

## Question: How to compare diatom and psm sampling sites?
Where were samples taken at the same location?

Which column should I use to compare both datasets?
Random check if site_id exists in dia_sam.
Result: site_id is not the same in psm_samples and dia_sam.
Maybe labelling system is still the same, samples were just not always taken at same location?
```{r echo=TRUE, message=FALSE}
# Random site_id taken from psm_samples
dia_sam[dia_sam$site_id=="BW_10001",] #no result
dia_sam[dia_sam$site_id=="RP_10002",] #no results
# Random site_id taken from dia_samples as a cross-check if code is correct.
dia_sam[dia_sam$site_id=="BW_AI025.00",] #185 results

```
Is site_name, site_id and site_nr the same in psm_sites dataset? 
Find out by counting distinct occurence of them.
Result: site_id and site_name does not mean the same.
Site_id and site_nr might be approximately the same.
``` {r echo=TRUE, message=FALSE}
# Complete data set has to be queried before!!
psm_siteid_list <- unique(psm_sites$site_id)
nrow(as.data.frame(psm_siteid_list)) # 3116 different entries for site_id in psm_sites

psm_sitename_list <- unique(psm_sites$site_name)
nrow(as.data.frame(psm_sitename_list)) # 2746 different entries for site_name in psm_sites

psm_sitenr_list <- unique(psm_sites$site_nr)
nrow(as.data.frame(psm_sitenr_list)) # 3114 different entries for site_nr in psm_sites

```

Random check if site_nr in dia_sites and psm_sites are the same.
Result: site_nr in psm_sites and dia_sites are not the same.
Maybe labelling system is still the same, samples were just not always taken at same location?
Check the other way around. Are site_nr of dia_sites found in psm_sites?
Result: Positive. Dia samples were probably not taken at all psm sampling locations.
```{r echo=TRUE, message=FALSE}
# Random site_nr taken from psm_sites
dia_sites[dia_sites$site_nr=="CAC029",] # no results
dia_sites[dia_sites$site_nr=="21094",] # no results
dia_sites[dia_sites$site_nr=="CEN901",] # no results
# Random site_nr taken from dia_sites as a cross-check to see if code is correct.
dia_sites[dia_sites$site_nr=="CEZ016",] # 1 result

# Check the other way around. Are site_nr of dia_sites found in psm_sites?
psm_sites[psm_sites$site_nr=="CEZ016",] # 1 result 
psm_sites[psm_sites$site_nr=="CKO317",] # 1 result
```

Random check if site_id in dia_sites and psm_sites are the same.
Result: Yes.
``` {r echo=TRUE, message=FALSE}
psm_sites[psm_sites$site_id=="BW_CEZ016",] # 1 result
psm_sites[psm_sites$site_id=="BW_CKO317",] # 1 result

```
# Result
site_id can be used to connect psm_sites and dia_sites since attribut is found in both tables.

site_id is the same in all four tables.
``` {r echo=TRUE, message=FALSE}
psm_sites[psm_sites$site_id=="RP_10002",] # 1 result
dia_sites[dia_sites$site_id=="BW_AI025.00",] # 1 result
```

## Compare both sample datasets
Filter sites where diatom and herbicide data was measured in the same year.
``` {r compare-sample-datasets, echo=TRUE, message=FALSE}
# Join both sample data frames. Add a column identifying which source each row comes from.
dia_sam$table <- "dia"
psm_samples$table <- "psm"
dia_sam_bind <- dia_sam[,c("date", "site_id", "table")]
psm_sam_bind <- psm_samples[,c("date", "site_id", "table")]
samples_bind <- rbind(dia_sam_bind,psm_sam_bind) # combine both sample tables

```

Create data frames with samples only from 2005.
``` {r create-year-column, echo=TRUE, message=FALSE}
# Create year column from date column
dia_sam$year <- as.numeric(format(dia_sam$date,'%Y'))
psm_samples$year <- as.numeric(format(psm_samples$date,'%Y'))

# Create data frames with samples only from 2005
dia_sam_05 <- dia_sam[dia_sam$year=="2005",]
psm_sam_05 <- psm_samples[psm_samples$year=="2005",]

# common <- intersect(dia_sam_05[,"site_id"], psm_sam_05[,"site_id"]) # results in empty data

```
Want to compare tables on year and site_id:
Include only herbicide data
Code is not appropriate yet.
```{r  join-on-siteid, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

sam_tab = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date, 
                    EXTRACT(YEAR FROM dsam.date) AS sam_year,
                    EXTRACT(YEAR FROM psam.date) AS psm_year
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON dsam.site_id = psam.site_id
                    LIMIT 100");

date_tab = dbGetQuery(con, " SELECT dsam.site_id, dsam.date
                     FROM dia.dia_samples AS dsam
                    WHERE dsam.date BETWEEN '2005-01-01' AND '2005-12-31'
                     ")

sam_tab1 = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date 
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON dsam.site_id = psam.site_id
                    WHERE (dsam.date BETWEEN '2005-01-01' AND '2005-12-31')
                     AND (psam.date BETWEEN '2005-01-01' AND '2005-12-31')
                    ")

# Horrible style but at least it works...
dia_herb_year = dbGetQuery(con, " SELECT dsam.site_id, dsam.date AS d_date, 
                     psam.date AS p_date
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON dsam.site_id = psam.site_id
                     JOIN phch.phch_variables AS var 
                      ON var.variable_id = psam.variable_id
                    WHERE var.psm_type = 'herbicide'
                     AND   (((dsam.date BETWEEN '2005-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2005-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2006-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2006-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2007-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2007-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2008-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2008-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2009-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2009-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2010-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2010-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2011-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2011-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2012-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2012-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2013-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2013-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2014-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2014-01-01' AND '2005-12-31'))
                     OR ((dsam.date BETWEEN '2015-01-01' AND '2005-12-31')
                           AND (psam.date BETWEEN '2015-01-01' AND '2005-12-31')))
                    LIMIT 1000")


sam_2join = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date 
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON (dsam.site_id = psam.site_id)
                    AND (dsam.date = psam.date)
                    ")

sam_2join1 = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date, 
                      EXTRACT(YEAR FROM dsam.date) AS sam_year,
                     EXTRACT(YEAR FROM psam.date) AS psm_year
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON (dsam.site_id = psam.site_id)
                    AND (dsam.date = psam.date)
                    LIMIT 100")

# ERROR: sam_year does not exist
sam_2join2 = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date, 
                      EXTRACT(YEAR FROM dsam.date) AS sam_year,
                     EXTRACT(YEAR FROM psam.date) AS psm_year
                     FROM dia.dia_samples AS dsam
                     INNER JOIN views.psm_samples_2005 AS psam 
                     ON (dsam.site_id = psam.site_id)
                    AND (dsam.date = psam.date)
                    LIMIT 100")


# sam_tab1 = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date, 
#                    EXTRACT(YEAR FROM dsam.date) AS sam_year,
#                    EXTRACT(YEAR FROM psam.date) AS psm_year
#                     FROM dia.dia_samples AS dsam
#                     INNER JOIN views.psm_samples_2005 AS psam 
#                     ON dsam.site_id = psam.site_id
#                    WHERE sam_year LIKE '2006'
#                    LIMIT 100");


# All queries don't work:

# sam_tab2 = dbGetQuery(con, " SELECT dsam.site_id, dsam.date, psam.date, 
#                    EXTRACT(YEAR FROM dsam.date) AS sam_year,
#                    EXTRACT(YEAR FROM psam.date) AS psm_year
#                     FROM dia.dia_samples AS dsam
#                     INNER JOIN views.psm_samples_2005 AS psam 
#                     ON dsam.sam_year = psam.psm_year
#                    LIMIT 100");


# sam_tab2 = dbGetQuery(con, "SELECT site_id, sam_year, psm_year
#       FROM sam_tab AS tab1
#       INNER JOIN AS tab2
#       ON tab1.sam_year = tab2.psm_year")

# sqldf("SELECT site_id, sam_year, psm_year
#       FROM sam_tab AS tab1
#       INNER JOIN AS tab2
#       ON tab1.sam_year = tab2.psm_year")

         
dbDisconnect(con)
dbUnloadDriver(drv)
```

