---
title: "Untitled"
author: "Gesa Amelung"
date: "7 November 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

Load the following packages and load the data base access scipt:

```{r setup, echo=TRUE, message=FALSE}
## load packages
require(RPostgreSQL)
require(sf)
require(knitr)

## load access data
path = 'D:/Gesa/Dokumente/Ecotoxicology/RPC'
source(file.path(path, 'amelung_access.R'))

```

## Loading data

Query PostgresSQL data base: bfg_monitoring
Cannot load full psm_samples so far, maybe internet is too weak..

```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

psm_sites = dbGetQuery(con, "SELECT *
                             FROM views.psm_sites_2005
                       LIMIT 10")
psm_samples = dbGetQuery(con, "SELECT *
                               FROM views.psm_samples_2005 sam
                               JOIN phch.phch_variables var ON var.variable_id = sam.variable_id LIMIT 10")

dbDisconnect(con)
dbUnloadDriver(drv)
```

```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

require(RPostgreSQL)
require(sf)
require(mapview)

dia_sites = dbGetQuery(con, "SELECT * FROM dia.dia_sites LIMIT 10")
dia_sites_geo = st_read_db(con, query = "SELECT * FROM dia.dia_sites LIMIT 10")
dia_sam = dbGetQuery(con, "SELECT * FROM dia.dia_samples LIMIT 10")
mapview(dia_sites_geo)

dbDisconnect(con)
dbUnloadDriver(drv)
```

## Get  diatom samples sampled after 2004

There are diatom samples from 2004 in the database. For the PSM data, no samples of 2004 are in the database. Therefore, data doesn't need to be queried specifically.

```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

dia_sam_05 = dbGetQuery(con, "SELECT *
                       FROM dia.dia_samples
                       WHERE date > '2004-12-31'
                       LIMIT 100")

dbDisconnect(con)
dbUnloadDriver(drv)
```

## Combine both sample tables

Combine table psm_samples mit dia_samples Ã¼ber die Spalte "date".
Not very useful but keep code anyways.

```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

sam_tab = dbGetQuery(con, " SELECT * 
                      FROM dia.dia_samples AS dsam
                      INNER JOIN views.psm_samples_2005 AS psam
                      ON dsam.date = psam.date
                      LIMIT 100")

dbDisconnect(con)
dbUnloadDriver(drv)
```
```{r load-PSM-data, echo=TRUE, message=FALSE}
drv = dbDriver("PostgreSQL")
con = dbConnect(drv, dbname = DBname, user = DBuser, host = DBhost, port = DBport, password = DBpassword)

sam_tab = dbGetQuery(con, " SELECT *
                     FROM LIMIT 100")

dbDisconnect(con)
dbUnloadDriver(drv)
```

## Question: How to compare diatom and psm sampling sites?
Where were samples taken at the same location?

Random check if site_id exists in dia_2005.
Result: site_id is not the same in psm_samples and dia_sam_05.
```{r}
dia_sam_05[dia_2005$site_id=="BW_10001",] #no result
dia_sam_05[dia_2005$site_id=="BW_AI025.00",] #high output
```
Is site_name, site_id and site_nr the same? 
Find out by counting distinct occurence of them.
Result: site_id and site_name does not mean the same.
Site_id and site_nr might be approximately the same.
``` {r}
psm_siteid_list <- unique(psm_sites$site_id)
nrow(as.data.frame(psm_siteid_list)) # 3116 different entries for site_id in psm_sites

psm_sitename_list <- unique(psm_sites$site_name)
nrow(as.data.frame(psm_sitename_list)) # 2746 different entries for site_name in psm_sites

psm_sitenr_list <- unique(psm_sites$site_nr)
nrow(as.data.frame(psm_sitenr_list)) # 3114 different entries for site_nr in psm_sites

```


